services:
  finance-server:
    build: .
    container_name: finance-domain-server
    environment:
      - MCP_URL=${MCP_URL:-http://host.docker.internal:8000/sse}
      - PYTHONPATH=/app
      - REGISTRY_DB_PATH=/app/data/registry.db
    ports:
      - "8003:8001"
    volumes:
      - agent-api-data:/app/data
    command: python domains/finance/server.py
    extra_hosts:
      - "host.docker.internal:host-gateway"

  communication-domain:
    build:
      context: ./communication-domain
    container_name: communication-domain
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_DEFAULT_CHAT_ID=${TELEGRAM_DEFAULT_CHAT_ID:-}
      - TELEGRAM_DRY_RUN=${TELEGRAM_DRY_RUN:-true}
      - TELEGRAM_TIMEOUT_SECONDS=${TELEGRAM_TIMEOUT_SECONDS:-10}
      - TELEGRAM_ALLOWED_CHAT_IDS=${TELEGRAM_ALLOWED_CHAT_IDS:-}
    ports:
      - "8002:8002"

  agent:
    build: .
    container_name: finance-agent
    stdin_open: true # Allows interactive CLI
    tty: true # Allows interactive CLI
    environment:
      - OLLAMA_URL=${OLLAMA_URL:-http://host.docker.internal:11434}
      - MODEL_PROVIDER=${MODEL_PROVIDER:-ollama}
      - MODEL_BASE_URL=${MODEL_BASE_URL:-}
      - MODEL_API_KEY=${MODEL_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - ANTHROPIC_VERSION=${ANTHROPIC_VERSION:-2023-06-01}
      - INTENT_MODEL_NAME=${INTENT_MODEL_NAME:-}
      - ORCHESTRATOR_CLARIFICATION_MODEL=${ORCHESTRATOR_CLARIFICATION_MODEL:-}
      - GENERAL_MODEL_NAME=${GENERAL_MODEL_NAME:-}
      - REGISTRY_DB_PATH=/app/registry.db
      - DB_PATH=/app/agent.db
      - MEMORY_DB_PATH=/app/memory.db
      - MCP_URL=${MCP_URL:-http://host.docker.internal:8000/sse}
      - BOOTSTRAP_DOMAINS_FILE=/app/domains.bootstrap.json
      - AUTO_SYNC_REMOTE_CAPABILITIES=true
      - PYTHONPATH=/app
      - INTENT_MODEL_TIMEOUT_SECONDS=${INTENT_MODEL_TIMEOUT_SECONDS:-25}
      - INTENT_MODEL_MAX_RETRIES=${INTENT_MODEL_MAX_RETRIES:-2}
      - ORCHESTRATOR_CLARIFICATION_TIMEOUT_SECONDS=${ORCHESTRATOR_CLARIFICATION_TIMEOUT_SECONDS:-12}
      - ORCHESTRATOR_CLARIFICATION_MAX_RETRIES=${ORCHESTRATOR_CLARIFICATION_MAX_RETRIES:-1}
      - ORCHESTRATOR_TEST_MODE=${ORCHESTRATOR_TEST_MODE:-false}
      - PLANNER_FUNCTION_CALLING_ENABLED=${PLANNER_FUNCTION_CALLING_ENABLED:-false}
      - PLANNER_TIMEOUT_SECONDS=${PLANNER_TIMEOUT_SECONDS:-20}
      - GENERAL_FASTPATH_ENABLED=${GENERAL_FASTPATH_ENABLED:-true}
    volumes:
      - agent-data:/app
      - ./domains.bootstrap.json:/app/domains.bootstrap.json:ro
    depends_on:
      - finance-server
      - communication-domain
    command: python main.py run
    extra_hosts:
      - "host.docker.internal:host-gateway"

  agent-api:
    build: .
    container_name: finance-agent-api
    environment:
      - OLLAMA_URL=${OLLAMA_URL:-http://host.docker.internal:11434}
      - MODEL_PROVIDER=${MODEL_PROVIDER:-ollama}
      - MODEL_BASE_URL=${MODEL_BASE_URL:-}
      - MODEL_API_KEY=${MODEL_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - ANTHROPIC_VERSION=${ANTHROPIC_VERSION:-2023-06-01}
      - INTENT_MODEL_NAME=${INTENT_MODEL_NAME:-}
      - ORCHESTRATOR_CLARIFICATION_MODEL=${ORCHESTRATOR_CLARIFICATION_MODEL:-}
      - GENERAL_MODEL_NAME=${GENERAL_MODEL_NAME:-}
      - REGISTRY_DB_PATH=/app/data/registry.db
      - DB_PATH=/app/data/agent.db
      - MEMORY_DB_PATH=/app/data/memory.db
      - MCP_URL=${MCP_URL:-http://host.docker.internal:8000/sse}
      - BOOTSTRAP_DOMAINS_FILE=/app/domains.bootstrap.json
      - AUTO_SYNC_REMOTE_CAPABILITIES=true
      - PYTHONPATH=/app
      - INTENT_MODEL_TIMEOUT_SECONDS=${INTENT_MODEL_TIMEOUT_SECONDS:-25}
      - INTENT_MODEL_MAX_RETRIES=${INTENT_MODEL_MAX_RETRIES:-2}
      - ORCHESTRATOR_CLARIFICATION_TIMEOUT_SECONDS=${ORCHESTRATOR_CLARIFICATION_TIMEOUT_SECONDS:-12}
      - ORCHESTRATOR_CLARIFICATION_MAX_RETRIES=${ORCHESTRATOR_CLARIFICATION_MAX_RETRIES:-1}
      - ORCHESTRATOR_TEST_MODE=${ORCHESTRATOR_TEST_MODE:-false}
      - PLANNER_FUNCTION_CALLING_ENABLED=${PLANNER_FUNCTION_CALLING_ENABLED:-false}
      - PLANNER_TIMEOUT_SECONDS=${PLANNER_TIMEOUT_SECONDS:-20}
      - GENERAL_FASTPATH_ENABLED=${GENERAL_FASTPATH_ENABLED:-true}
      - OPENAI_API_PRELOAD_MODELS=${OPENAI_API_PRELOAD_MODELS:-true}
      - OPENAI_API_PRELOAD_TIMEOUT_SECONDS=${OPENAI_API_PRELOAD_TIMEOUT_SECONDS:-40}
      - OPENAI_API_SIMULATED_STREAM_DELAY_MS=${OPENAI_API_SIMULATED_STREAM_DELAY_MS:-12}
      - OPENAI_API_STREAM_PROGRESS_FORMAT=${OPENAI_API_STREAM_PROGRESS_FORMAT:-json_pretty}
      - OPENAI_API_SUGGESTIONS_IN_CONTENT=${OPENAI_API_SUGGESTIONS_IN_CONTENT:-false}
      - OPENAI_API_SUGGESTION_ACTIONS_IN_CONTENT=${OPENAI_API_SUGGESTION_ACTIONS_IN_CONTENT:-false}
    volumes:
      - agent-api-data:/app/data
      - ./domains.bootstrap.json:/app/domains.bootstrap.json:ro
    depends_on:
      - finance-server
      - communication-domain
    command: uvicorn api.openai_server:app --host 0.0.0.0 --port 8010
    ports:
      - "8010:8010"
    extra_hosts:
      - "host.docker.internal:host-gateway"

  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    environment:
      # Auth and Core
      - WEBUI_AUTH=False
      - ENABLE_SIGNUP=False

      # Backend API Configuration
      - OPENAI_API_BASE_URL=${OPENAI_API_BASE_URL:-http://agent-api:8010/v1}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-sk-local-dev}

      # LLM Configuration
      - OLLAMA_BASE_URL=${OLLAMA_BASE_URL:-http://host.docker.internal:11434}

      # UI and Features
      - ENABLE_IMAGE_GENERATION=False
      - ENABLE_MODELS_FILTER=True
      - ENABLE_MODEL_FILTERING=True
      - SHOW_ADMIN_DETAILS=False

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

      # Optional: Disable telemetry
      - DO_NOT_TRACK=True
    ports:
      - "3000:8080"
    volumes:
      - open-webui-data:/app/backend/data
    depends_on:
      - agent-api
    extra_hosts:
      - "host.docker.internal:host-gateway"

networks:
  default:
    name: agent-orchestrator
    driver: bridge

volumes:
  db-data:
  agent-data:
  agent-api-data:
  open-webui-data:
